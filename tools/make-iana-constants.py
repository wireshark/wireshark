#!/usr/bin/env python3
#
# Wireshark - Network traffic analyzer
# By Gerald Combs <gerald@wireshark.org>
# Copyright 1998 Gerald Combs
#
# SPDX-License-Identifier: GPL-2.0-or-later
'''Update the IANA Address family numbers and IP protocol numbers file.

Make-iana-constants creates a file containing Address family numbers.
'''

#import csv
import io
import os
import sys
import urllib.request
import urllib.error
import urllib.parse
import xml.etree.ElementTree as ET

def exit_msg(msg=None, status=1):
    if msg is not None:
        sys.stderr.write(msg + '\n\n')
    sys.stderr.write(__doc__ + '\n')
    sys.exit(status)

class AddressFamilyNumber:
    def __init__(self, value, description):
        self.value = value
        self.description = description.replace('"', '\'')
        self.define = self.make_define(description)

    def make_define(self, text):
        name = text
        remove_data_index = name.find('(')
        if remove_data_index != -1:
            name = name[:remove_data_index]

        name = name.strip()
        name = name.upper()
        name = name.replace('-', ' ')
        name = name.replace('/', ' ')
        name = name.replace('.', '')
        name = ''.join(c if c.isalnum() else ' ' for c in name)
        name = '_'.join(name.split())

        #Special handling for RESERVED because it appears multiple times
        if name == 'RESERVED':
            name = 'RESERVED_' + self.value
        return f"AFNUM_{name}"

afnum_url = "https://www.iana.org/assignments/address-family-numbers/address-family-numbers.xml"
afnum_ns = "http://www.iana.org/assignments"
ipproto_url = "http://www.iana.org/assignments/protocol-numbers/protocol-numbers.xml"

def get_afnum_data():
    print('Loading Address Family Numbers data from {}'.format(afnum_url))

    try:
        req = urllib.request.Request(afnum_url)
        response = urllib.request.urlopen(req)
        body = response.read().decode('UTF-8', 'replace')
    except Exception:
        exit_msg('Error opening ' + afnum_url)


    tree = ET.fromstring(body)
    registry = tree.find(f"{{{afnum_ns}}}registry")

    #Convert XML records to list of tuples
    records = []
    for record in registry.findall(f"{{{afnum_ns}}}record"):
        value = record.find(f"{{{afnum_ns}}}value").text
        description = record.find(f"{{{afnum_ns}}}description").text
        records.append(AddressFamilyNumber(value, description))

    return records

def generate_afnum_data():
    iana_h_path = os.path.join(os.path.dirname(__file__), '..', 'epan', 'dissectors', 'packet-iana-data.h')
    iana_c_path = os.path.join(os.path.dirname(__file__), '..', 'epan', 'dissectors', 'packet-iana-data.c')

    iana_h_data = '''\
/*
 * This file was generated by running ./tools/make-iana-constants.py.
 *
 * SPDX-License-Identifier: GPL-2.0-or-later
 */
#ifndef __PACKET_IANA_DATA_H__
#define __PACKET_IANA_DATA_H__

#include "ws_symbol_export.h"
#include <wsutil/value_string.h>

#ifdef __cplusplus
extern "C" {
#endif /* __cplusplus */

/*
 * Address family numbers, from
 *
 *  http://www.iana.org/assignments/address-family-numbers
 */
'''

    iana_h_tail = '''\

WS_DLL_PUBLIC const value_string afn_vals[];

#ifdef __cplusplus
}
#endif /* __cplusplus */

#endif /* __PACKET_IANA_DATA_H__ */
'''

    iana_c_data = '''\
/*
 * This file was generated by running ./tools/make-iana-constants.py.
 *
 * SPDX-License-Identifier: GPL-2.0-or-later
 */

#include "config.h"

#include <wsutil/value_string.h>
#include "packet-iana-data.h"

const value_string afn_vals[] = {
'''

    iana_c_tail = '''\
\t{ 0, NULL },
};
'''

    afnum_data = get_afnum_data()
    if afnum_data is not None:
        try:
            with io.open(iana_h_path, 'w', encoding='UTF-8') as iana_f:
                iana_f.write(iana_h_data)
                for record in afnum_data:
                    if record.value.find('-') != -1:
                        #Skip ranges
                        continue

                    define = record.define.ljust(50)
                    value = record.value.ljust(10)
                    iana_f.write(f"#define {define}{value}/* {record.description} */\n")
                iana_f.write(iana_h_tail)

        except Exception:
            exit_msg("Couldn't open \"{}\" file for writing".format(iana_h_path))

        try:
            with io.open(iana_c_path, 'w', encoding='UTF-8') as iana_f:
                iana_f.write(iana_c_data)
                for record in afnum_data:
                    if record.value.find('-') != -1:
                        #Skip ranges
                        continue

                    predefine = record.define + ','
                    define = predefine.ljust(50)
                    iana_f.write(f"\t{{ {define}\"{record.description}\"}},\n")
                iana_f.write(iana_c_tail)
        except Exception:
            exit_msg("Couldn't open \"{}\" file for writing".format(iana_c_path))

def main():
    generate_afnum_data()

if __name__ == '__main__':
    main()
